<div class="container">
  @if (isLoadingExternes) {
    <div class="full-page-loader">
      <div class="loader-content">
        <div class="big-spinner"></div>
        <p>Veuillez patienter, les vols sont en cours de chargement...</p>
      </div>
    </div>
  }
  <h2>Gestion des Vols</h2>
  <p class="section-subtitle">G√©rez les vols, leurs statuts et les assignations</p>
  <button type="button" (click)="loadVolsExternes()" class="btn-sm"
          style="background: var(--primary);; color: white; padding: 8px 16px; border-radius: 10px">
    @if (isLoadingExternes) {
      <span class="spinner"></span>
      Chargement...
    } @else {
      üîç Voir Vols Partenaires (FTG)
    }
  </button>
  @if (errorMessage) {
    <div class="error">
      {{ errorMessage }}
    </div>
  }

  <!-- Formulaire -->
  <div class="form-section">
    <div class="form-header">
      <h3 class="form-title">{{ editing ? 'Modifier un vol' : 'Ajouter un vol' }}</h3>
      @if (editing) {
        <span class="edit-badge">
          ‚úèÔ∏è Modification: {{ editingNumeroVol }}
        </span>
      }
    </div>

    <form (ngSubmit)="saveVol()">
      @if (!editing) {
        <div class="form-group">
          <label>Num√©ro de vol *</label>
          <input [(ngModel)]="newVolCreate.numeroVol" name="numeroVol"
                 placeholder="Ex: AF123"
                 style="text-transform: uppercase;"
                 (input)="newVolCreate.numeroVol = newVolCreate.numeroVol.toUpperCase()"
                 required>
        </div>

        <div class="form-group">
          <label>Type de vol *</label>
          <select [(ngModel)]="newVolCreate.type" name="type" required>
            <option value="" disabled>-- Type de vol --</option>
            @for (type of typeOptions; track $index) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Origine *</label>
          <select [(ngModel)]="newVolCreate.origine" name="aeroportCodeIATA" class="form-control">
            <option [ngValue]="null">-- Ville d'origine --</option>
            <option *ngFor="let aeroport of aeroports" [ngValue]="aeroport.ville">
              {{ aeroport.ville }}
            </option>
          </select>

          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            S√©lectionnez le point de d√©part
          </small>
        </div>

        <div class="form-group">
          <label>Destination *</label>
          <select [(ngModel)]="newVolCreate.destination" name="aeroportCodeIATA" class="form-control">
            <option [ngValue]="null">-- Ville d'arriv√©e --</option>
            <option *ngFor="let aeroport of aeroports" [ngValue]="aeroport.ville">
              {{ aeroport.ville }}
            </option>
          </select>

          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            S√©lectionnez le point d'arriv√©
          </small>
        </div>

        <div class="form-group">
          <label>Heure de d√©part *</label>
          <input [(ngModel)]="newVolCreate.heureDepart" name="heureDepart"
                 type="datetime-local" [min]="getMinDateTime()" required>
          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            L'heure de d√©part doit √™tre post√©rieure √† maintenant ({{ getCurrentDateTime() }})
          </small>
        </div>

        <div class="form-group">
          <label>Heure d'arriv√©e *</label>
          <input [(ngModel)]="newVolCreate.heureArrivee" name="heureArrivee"
                 type="datetime-local" required>
          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            L'heure d'arriv√©e doit √™tre post√©rieure √† l'heure de d√©part
          </small>
        </div>

        <div class="form-group">
          <label>Code IATA A√©roport D√©part *</label>
          <select [(ngModel)]="newVolCreate.aeroportDepartCodeIATA"
                  name="aeroportDepartCodeIATA"
                  class="form-control"
                  required
                  [disabled]="!newVolCreate.origine">
            <option [ngValue]="null">
              {{ !newVolCreate.origine ? '-- S√©lectionnez d\'abord une ville d\'origine --' : '-- Aucun a√©roport --' }}
            </option>
            <option *ngFor="let aeroport of getAeroportsDepart()" [ngValue]="aeroport.codeIATA">
              {{ aeroport.codeIATA }} - {{ aeroport.nom }}
            </option>
          </select>

          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            @if (newVolCreate.origine) {
              S√©lectionnez l'a√©roport de d√©part √† {{ newVolCreate.origine }}
            } @else {
              Veuillez d'abord s√©lectionner une ville d'origine
            }
          </small>
        </div>

        <div class="form-group">
          <label>Code IATA A√©roport Arriv√©e *</label>
          <select [(ngModel)]="newVolCreate.aeroportArriveeCodeIATA"
                  name="aeroportArriveeCodeIATA"
                  class="form-control"
                  required
                  [disabled]="!newVolCreate.destination">
            <option [ngValue]="null">
              {{ !newVolCreate.destination ? '-- S√©lectionnez d\'abord une ville de destination --' : '-- Aucun a√©roport --' }}
            </option>
            <option *ngFor="let aeroport of getAeroportsArrivee()" [ngValue]="aeroport.codeIATA">
              {{ aeroport.codeIATA }} - {{ aeroport.nom }}
            </option>
          </select>

          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            @if (newVolCreate.destination) {
              S√©lectionnez l'a√©roport d'arriv√©e √† {{ newVolCreate.destination }}
            } @else {
              Veuillez d'abord s√©lectionner une ville de destination
            }
          </small>
        </div>
      }

      @if (editing) {
        <div class="form-group">
          <label>Heure de d√©part *</label>

          <input [(ngModel)]="newVolUpdate.heureDepart" name="heureDepart"
                 type="datetime-local"
                 [min]="getMinDateTime()"
                 [disabled]="isHeureDepartDisabled(currentEditingVol)"
                 required>

          @if (isHeureDepartDisabled(currentEditingVol)) {
            <small style="color: #ef4444; display: block; margin-top: 0.25rem;">
              Modification impossible : le vol est d√©j√† en cours ou d√©tourn√©.
            </small>
          }

          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            L'heure de d√©part doit √™tre sup√©rieure √† maintenant ({{ getCurrentDateTime() }})
          </small>
        </div>

        <div class="form-group">
          <label>Heure d'arriv√©e *</label>
          <input [(ngModel)]="newVolUpdate.heureArrivee" name="heureArrivee"
                 type="datetime-local" required>
          <small style="color: var(--secondary); font-size: 0.813rem; margin-top: 0.25rem; display: block;">
            L'heure d'arriv√©e doit √™tre sup√©rieure √† l'heure de d√©part
          </small>
        </div>
      }

      <div class="btn-group">
        <button type="submit" class="btn-primary">
          {{ editing ? 'üíæ Modifier' : '‚ûï Ajouter' }}
        </button>
        @if (editing) {
          <button type="button" (click)="cancel()" class="btn-secondary">
            ‚úñÔ∏è Annuler
          </button>
        }
      </div>
    </form>
  </div>

  <!-- Tableau des vols -->
  <div class="table-container">
    <div class="table-header">
      <div class="table-title">üåç Liste des Vols ({{ vols.length }})</div>
    </div>

    @if (vols.length === 0) {
      <div class="empty-state">
        <div class="empty-state-icon">üåç</div>
        <div class="empty-state-text">Aucun vol enregistr√©</div>
        <p class="empty-state-subtext">Commencez par ajouter votre premier vol</p>
      </div>
    } @else {
      <table>
        <thead>
        <tr>
          <th>Num√©ro</th>
          <th>Type</th>
          <th>Trajet</th>
          <th>Horaires</th>
          <th>Statut</th>
          <th>Avion</th>
          <th>Pistes</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
          @for (vol of vols; track vol.numeroVol) {
            <tr>
              <td>
                <div><strong>{{ vol.numeroVol }}</strong></div>
              </td>
              <td>
                <span class="status-badge"
                      [class.status-libre]="vol.type === 'NATIONAL'"
                      [class.status-occupee]="vol.type === 'INTERNATIONAL'">
                  {{ vol.type }}
                </span>
              </td>
              <td>
                <div>üìç {{ vol.origine }}</div>
                <div style="color: var(--secondary); font-size: 0.875rem;">
                  ‚Üí {{ vol.destination }}
                </div>
                @if (vol.aeroportDepartCodeIATA || vol.aeroportArriveeCodeIATA) {
                  <div style="font-size: 0.75rem; color: var(--secondary); margin-top: 0.25rem;">
                    {{ vol.aeroportDepartCodeIATA || '?' }} ‚Üí {{ vol.aeroportArriveeCodeIATA || '?' }}
                  </div>
                }
              </td>
              <td>
                <div><strong>D√©part:</strong> {{ vol.heureDepart | date:'short' }}</div>
                <div style="color: var(--secondary); font-size: 0.875rem;">
                  <strong>Arriv√©e:</strong> {{ vol.heureArrivee | date:'short' }}
                </div>
                <div style="font-size: 0.75rem; color: var(--secondary); margin-top: 0.25rem;">
                  ‚è±Ô∏è {{ formatDuree(vol.dureeTotale) }}
                </div>
              </td>
              <td>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start;">
                  <span class="status-badge"
                        [class.status-libre]="vol.statut === 'PROGRAMME'"
                        [class.status-occupee]="vol.statut === 'EN_VOL' || vol.statut === 'ENREGISTREMENT' || vol.statut === 'EN_APPROCHE' || vol.statut === 'DECOLLE' || vol.statut === 'PRET_DECOLLAGE' || vol.statut === 'EMBARQUEMENT'"
                        [class.status-maintenance]="vol.statut === 'ATTERRI' || vol.statut === 'RETARDE' || vol.statut === 'ARRIVE' "
                        [class.status-danger]="vol.statut === 'ANNULE' || vol.statut === 'DETOURNE'">
                    {{ vol.statut }}
                  </span>
                  <button type="button"
                          (click)="openChangeStatut(vol)"
                          class="btn-sm"
                          style="background: var(--secondary); color: white; font-size: 0.813rem;">
                    üîÑ Changer
                  </button>
                </div>
              </td>


              <!--ASSIGNER AVION -->
              <td>
                @if (vol.avionImmatriculation) {
                  <span class="status-badge status-libre">
                ‚úàÔ∏è {{ vol.avionImmatriculation }}
              </span>
                } @else {
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <span style="color: var(--secondary); font-style: italic; font-size: 0.875rem;">
                  Non assign√©
                </span>
                    @if (!vol.pisteDepartIdentifiant) {
                      <!-- Bouton combin√© : avion + piste d√©part -->
                      <button type="button"
                              (click)="openPreparerVol(vol.numeroVol)"
                              class="btn-success btn-sm"
                              style="background: var(--success); color: white;"
                              title="Pr√©parer le vol (assigner avion + piste)">
                        üöÄ Assigner un avion
                      </button>
                    } @else {
                      <!-- Assignation individuelle avion -->
                      <button type="button"
                              (click)="openAssignerAvion(vol.numeroVol)"
                              class="btn-success btn-sm">
                        ‚ûï Assigner
                      </button>
                    }
                  </div>
                }
              </td>

              <!-- ASSIGNER PISTE -->
              <td>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <!-- Piste d√©part -->
                  <div>
                    <strong style="font-size: 0.75rem;">üõ´ D√©part:</strong>
                    @if (vol.pisteDepartIdentifiant) {
                      <div style="display: flex; gap: 0.25rem; align-items: center; margin-top: 0.25rem;">
          <span class="status-badge status-libre" style="font-size: 0.75rem;">
            {{ vol.pisteDepartIdentifiant }}
          </span>
                        <button (click)="libererPiste(vol.numeroVol, 'depart')"
                                class="btn-danger"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                          ‚úñÔ∏è
                        </button>
                      </div>
                    } @else {
                      @if (vol.avionImmatriculation) {
                        <!-- Assignation individuelle si avion assign√© -->
                        <button (click)="openAssignerPiste(vol.numeroVol, 'depart')"
                                class="btn-sm"
                                style="background: var(--success); color: white; font-size: 0.75rem; margin-top: 0.25rem;"
                                title="Assigner piste d√©part">
                          ‚ûï
                        </button>
                      } @else {
                        <!-- Indiquer d'utiliser le bouton combin√© -->
                        <span style="color: var(--secondary); font-style: italic; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
            Via Assigner un avion
          </span>
                      }
                    }
                  </div>

                  <!-- Piste arriv√©e -->
                  <div>
                    <strong style="font-size: 0.75rem;">üõ¨ Arriv√©e:</strong>
                    @if (vol.pisteArriveeIdentifiant) {
                      <div style="display: flex; gap: 0.25rem; align-items: center; margin-top: 0.25rem;">
          <span class="status-badge status-occupee" style="font-size: 0.75rem;">
            {{ vol.pisteArriveeIdentifiant }}
          </span>
                        <button (click)="libererPiste(vol.numeroVol, 'arrivee')"
                                class="btn-danger"
                                style="padding: 0.25rem 0.25rem; font-size: 0.75rem;">
                          ‚úñÔ∏è
                        </button>
                      </div>
                    } @else {
                      <!-- Style identique √† Avion : texte + bouton üõ¨ -->
                      <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-top: 0.25rem;">
          <span style="color: var(--secondary); font-style: italic; font-size: 0.75rem;">
            Non assign√©e
          </span>
                        <button (click)="openPreparerAtterrissage(vol.numeroVol)"
                                class="btn-sm"
                                style="background: #3b82f6; color: white; font-size: 0.75rem;"
                                title="Pr√©parer l'atterrissage">
                          üõ¨ Assigner piste(s)
                        </button>
                      </div>
                    }
                  </div>
                </div>
              </td>

              <td>
                <div class="action-buttons">
                  <button (click)="editVol(vol)"
                          class="btn-warning btn-sm"
                          [disabled]="!canEditVol(vol)"
                          [title]="!canEditVol(vol) ? 'Modification interdite pour ce statut' : 'Modifier le vol'"
                          [style.opacity]="canEditVol(vol) ? '1' : '0.5'"
                          [style.cursor]="canEditVol(vol) ? 'pointer' : 'not-allowed'">
                    ‚úèÔ∏è
                  </button>
                  <button (click)="deleteVol(vol.numeroVol)"
                          class="btn-danger btn-sm"
                          [disabled]="vol.statut !== 'PROGRAMME'"
                          [title]="vol.statut === 'PROGRAMME' ? 'Supprimer le vol' : 'Ce vol ne peut pas √™tre supprim√©'"
                          [style.opacity]="vol.statut === 'PROGRAMME' ? '1' : '0.5'"
                          [style.cursor]="vol.statut === 'PROGRAMME' ? 'pointer' : 'not-allowed'">
                    üóëÔ∏è
                  </button>
                  <button (click)="consulterHistorique(vol)" class="btn-sm"
                          style="background: var(--secondary); color: white;">
                    {{ volHistoriqueSelectionne === vol.numeroVol ? 'üëÅÔ∏è' : 'üìú' }}
                  </button>
                </div>
              </td>
            </tr>
            <!-- Historique -->
            @if (volHistoriqueSelectionne === vol.numeroVol && historiqueAffiche) {
              <tr>
                <td colspan="8" style="background: var(--light); padding: 1.5rem;">
                  <h4 style="margin-bottom: 1rem;">üìú Historique du vol {{ vol.numeroVol }}</h4>

                  @if (historiqueAffiche.length === 0) {
                    <p style="color: var(--secondary); font-style: italic;">
                      Aucun historique disponible
                    </p>
                  } @else {
                    <table style="margin: 0; background: white;">
                      <thead>
                      <tr>
                        <th>Type d'action</th>
                        <th>Ancienne valeur</th>
                        <th>Nouvelle valeur</th>
                        <th>D√©tails</th>
                      </tr>
                      </thead>
                      <tbody>
                        @for (h of historiqueAffiche; track $index) {
                          <tr>
                            <td>
                              <span class="status-badge status-maintenance">
                                {{ h.typeAction }}
                              </span>
                            </td>
                            <td>{{ h.ancienneValeur || 'N/A' }}</td>
                            <td><strong>{{ h.nouvelleValeur }}</strong></td>
                            <td>{{ h.details || '-' }}</td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  }
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    }
  </div>


  <!-- Modal pour changer le statut -->
  @if (selectedVolForStatut) {
    <div class="modal-overlay" (click)="selectedVolForStatut = null">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">Changer le statut du vol {{ selectedVolForStatut.numeroVol }}</h3>
          <button class="close-btn" (click)="selectedVolForStatut = null">‚úñÔ∏è</button>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <p style="margin-bottom: 0.5rem;">
            <strong>Statut actuel:</strong>
            <span class="status-badge"
                  [class.status-libre]="selectedVolForStatut.statut === 'PROGRAMME'"
                  [class.status-occupee]="selectedVolForStatut.statut === 'EN_VOL' || selectedVolForStatut.statut === 'DECOLLE' || selectedVolForStatut.statut === 'PRET_DECOLLAGE'||
                    selectedVolForStatut.statut === 'EMBARQUEMENT'||selectedVolForStatut.statut === 'ENREGISTREMENT'||selectedVolForStatut.statut === 'EN_APPROCHE'||selectedVolForStatut.statut === 'ATTERRI'||selectedVolForStatut.statut === 'ARRIVE'"
                  style="margin-left: 0.5rem;">
              {{ selectedVolForStatut.statut }}
            </span>
          </p>
        </div>

        <div class="form-group">
          <label>Nouveau statut *</label>
          <select [(ngModel)]="nouveauStatut" style="width: 100%;">
            @for (statut of statutOptions; track $index) {
              <option [value]="statut"
                      [disabled]="!canTransitionTo(selectedVolForStatut, statut) && statut !== selectedVolForStatut.statut">
                {{ statut }}
              </option>
            }
          </select>
        </div>
        @if (nouveauStatut === 'ENREGISTREMENT' && !isPretPourEnregistrement(selectedVolForStatut)) {
          <div style="margin-top: 1.5rem; padding: 1rem; background-color: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; color: #b91c1c; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
            <div>
              <strong style="display: block;">Action requise avant l'enregistrement</strong>
              <p style="margin: 0; font-size: 0.875rem;">
                Vous devez imp√©rativement assigner un <strong>avion</strong> et une <strong>piste de d√©part</strong> avant de pouvoir valider ce statut.
              </p>
            </div>
          </div>
        }
        @if (nouveauStatut === 'EN_APPROCHE' && !isPretPourApproche(selectedVolForStatut)) {
          <div style="margin-top: 1.5rem; padding: 1rem; background-color:#fee2e2; border: 2px solid #ef4444; border-radius: 8px; color: #b91c1c; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5rem;">üõ¨</span>
            <div>
              <strong style="display: block;">Piste d'atterrissage requise</strong>
              <p style="margin: 0; font-size: 0.875rem;">
                Le vol ne peut pas passer en phase d'approche tant qu'une <strong>piste d'arriv√©e</strong> n'a pas √©t√© assign√©e.
              </p>
            </div>
          </div>
        }
        @if (nouveauStatut === 'PRET_DECOLLAGE' && !isPretPourDecollage(selectedVolForStatut)) {
          <div style="margin-top: 1.5rem; padding: 1rem; background-color: #fff7ed; border: 2px solid #f97316; border-radius: 8px; color: #9a3412; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5rem;">üõÇ</span>
            <div>
              <strong style="display: block;">Embarquement vide</strong>
              <p style="margin: 0; font-size: 0.875rem;">
                Impossible d'autoriser le d√©collage : <strong>aucun passager</strong> n'a encore √©t√© embarqu√© sur ce vol.
              </p>
            </div>
          </div>
        }
        @if (nouveauStatut === 'EMBARQUEMENT' && !isPretPourEmbarquement(selectedVolForStatut)) {
          <div style="margin-top: 1.5rem; padding: 1rem; background-color: #fff7ed; border: 2px solid #f97316; border-radius: 8px; color: #9a3412; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5rem;">üõÇ</span>
            <div>
              <strong style="display: block;">Enregistrement vide</strong>
              <p style="margin: 0; font-size: 0.875rem;">
                Impossible d'autoriser l'embarquement : <strong>aucun passager</strong> n'a encore √©t√© enregistr√© sur ce vol.
              </p>
            </div>
          </div>
        }


        @if (selectedVolForStatut.transitionsPossibles.length > 0) {
          <div style="margin-top: 1rem; padding: 1rem; background: var(--light); border-radius: 8px;">
            <strong style="font-size: 0.875rem;">‚úÖ Transitions autoris√©es:</strong>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
              @for (transition of selectedVolForStatut.transitionsPossibles; track $index) {
                <span class="status-badge status-libre" style="font-size: 0.75rem;">
                  {{ transition }}
                </span>
              }
            </div>
          </div>
        }

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
          <button (click)="changeStatut()"
                  class="btn-primary"
                  style="flex: 1;"
                  [disabled]="(nouveauStatut === 'ENREGISTREMENT' && !isPretPourEnregistrement(selectedVolForStatut)) ||
                     (nouveauStatut === 'EN_APPROCHE' && !isPretPourApproche(selectedVolForStatut)) ||
                      (nouveauStatut === 'PRET_DECOLLAGE' && !isPretPourDecollage(selectedVolForStatut)) ||
                      (nouveauStatut === 'EMBARQUEMENT' && !isPretPourEmbarquement(selectedVolForStatut))"
                  [style.opacity]="((nouveauStatut === 'ENREGISTREMENT' && !isPretPourEnregistrement(selectedVolForStatut)) ||
                                    (nouveauStatut === 'EN_APPROCHE' && !isPretPourApproche(selectedVolForStatut)) ||
                                    (nouveauStatut === 'PRET_DECOLLAGE' && !isPretPourDecollage(selectedVolForStatut))||
                                    (nouveauStatut === 'EMBARQUEMENT' && !isPretPourEmbarquement(selectedVolForStatut))) ? '0.5' : '1'"
                  [style.cursor]="((nouveauStatut === 'ENREGISTREMENT' && !isPretPourEnregistrement(selectedVolForStatut)) ||
                           (nouveauStatut === 'EN_APPROCHE' && !isPretPourApproche(selectedVolForStatut))
                           || (nouveauStatut === 'PRET_DECOLLAGE' && !isPretPourDecollage(selectedVolForStatut))||
                           (nouveauStatut === 'EMBARQUEMENT' && !isPretPourEmbarquement(selectedVolForStatut))) ? 'not-allowed' : 'pointer'">
            üíæ Valider
          </button>
          <button (click)="selectedVolForStatut = null" class="btn-secondary" style="flex: 1;">
            ‚úñÔ∏è Annuler
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal pour assigner un avion -->
  @if (selectedVolForAssignAvion) {
    <div class="modal-overlay" (click)="selectedVolForAssignAvion = null">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">Assigner un avion au vol {{ selectedVolForAssignAvion }}</h3>
          <button class="close-btn" (click)="selectedVolForAssignAvion = null">‚úñÔ∏è</button>
        </div>

        @if (avionsDisponibles.length > 0) {
          <ul class="item-list">
            @for (avion of avionsDisponibles; track avion.immatriculation) {
              <li>
                <div class="item-info">
                  <div class="item-title">‚úàÔ∏è {{ avion.immatriculation }}</div>
                  <div class="item-details">
                    üë• {{ avion.capacitePassager }} passagers ¬∑
                    üöÄ {{ avion.vitesseCroisiere }} km/h ¬∑
                    {{ avion.etatMaintenance }}
                  </div>
                </div>
                <button (click)="assignerAvionSelectionne(avion.immatriculation)"
                        class="btn-success btn-sm">
                  ‚ûï Assigner
                </button>
              </li>
            }
          </ul>
        } @else {
          <div class="empty-state">
            <p>Aucun avion disponible pour l'assignation</p>
          </div>
        }
      </div>
    </div>
  }
  <!-- Modal pour assigner une piste -->
  @if (selectedVolForAssignPiste) {
    <div class="modal-overlay" (click)="selectedVolForAssignPiste = null">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">
            Assigner une piste {{ typePiste === 'depart' ? 'de d√©part üõ´' : "d'arriv√©e üõ¨" }}
            au vol {{ selectedVolForAssignPiste }}
          </h3>
          <button class="close-btn" (click)="selectedVolForAssignPiste = null">‚úñÔ∏è</button>
        </div>

        @if (pistesDisponibles.length > 0) {
          <ul class="item-list">
            @for (piste of pistesDisponibles; track piste.identifiant) {
              <li>
                <div class="item-info">
                  <div class="item-title">üõ§Ô∏è Piste {{ piste.identifiant }}</div>
                  <div class="item-details">
                    üìè {{ piste.longueur }}m √ó {{ piste.largeur }}m ¬∑
                    üß≠ {{ piste.orientation }} ¬∑
                    ‚öñÔ∏è {{ piste.capaciteMaximale / 1000 }}t
                    @if (piste.aeroportCodeIATA) {
                      ¬∑ ‚úàÔ∏è {{ piste.aeroportCodeIATA }}
                    }
                  </div>
                </div>
                <button (click)="assignerPisteSelectionnee(piste.identifiant)"
                        class="btn-success btn-sm">
                  ‚ûï Assigner
                </button>
              </li>
            }
          </ul>
        } @else {
          <div class="empty-state">
            <p style="color: var(--secondary);">
              Aucune piste disponible pour cet a√©roport.
              @if (typePiste === 'depart') {
                V√©rifiez que le code IATA de l'a√©roport de d√©part est correct.
              } @else {
                V√©rifiez que le code IATA de l'a√©roport d'arriv√©e est correct.
              }
            </p>
          </div>
        }
      </div>
    </div>
  }

  <!-- Modal Pr√©parer le vol (avion + piste d√©part) -->
  @if (selectedVolForPreparation) {
    <div class="modal-overlay" (click)="selectedVolForPreparation = null">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">
            Pr√©parer le vol {{ selectedVolForPreparation }}
          </h3>
          <button class="close-btn" (click)="selectedVolForPreparation = null">‚úñÔ∏è</button>
        </div>

        <!-- S√©lection avion -->
        <div class="form-group">
          <label>Avion *</label>
          <select [(ngModel)]="selectedAvionForPreparation" style="width: 100%;">
            <option [ngValue]="''" disabled>-- S√©lectionner un avion --</option>
            @for (avion of avionsDisponibles; track avion.immatriculation) {
              <option [ngValue]="avion.immatriculation">
                {{ avion.immatriculation }} ¬∑ {{ avion.capacitePassager }} pax ¬∑ {{ avion.etatMaintenance }}
              </option>
            }
          </select>
        </div>

        <!-- S√©lection piste d√©part -->
        <div class="form-group" style="margin-top: 1rem;">
          <label>Piste de d√©part *</label>
          <select [(ngModel)]="selectedPisteForPreparation" style="width: 100%;">
            <option [ngValue]="''" disabled>-- S√©lectionner une piste --</option>
            @for (piste of pistesDisponibles; track piste.identifiant) {
              <option [ngValue]="piste.identifiant">
                Piste {{ piste.identifiant }} ¬∑ {{ piste.longueur }}m √ó {{ piste.largeur }}m ¬∑ {{ piste.orientation }}
              </option>
            }
          </select>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
          <button (click)="preparerVolComplet()" class="btn-primary" style="flex: 1;">
            üíæ Valider
          </button>
          <button (click)="selectedVolForPreparation = null" class="btn-secondary" style="flex: 1;">
            ‚úñÔ∏è Annuler
          </button>
        </div>
      </div>
    </div>
  }
  <!-- Modal Pr√©parer l'atterrissage (piste arriv√©e) -->
  @if (selectedVolForPreparationAtterrissage) {
    <div class="modal-overlay" (click)="selectedVolForPreparationAtterrissage = null">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">
            Pr√©parer l'atterrissage du vol {{ selectedVolForPreparationAtterrissage }}
          </h3>
          <button class="close-btn" (click)="selectedVolForPreparationAtterrissage = null">‚úñÔ∏è</button>
        </div>

        <div class="form-group">
          <label>Piste d'arriv√©e *</label>
          <select [(ngModel)]="selectedPisteForAtterrissage" style="width: 100%;">
            <option [ngValue]="''" disabled>-- S√©lectionner une piste --</option>
            @for (piste of pistesDisponibles; track piste.identifiant) {
              <option [ngValue]="piste.identifiant">
                Piste {{ piste.identifiant }} ¬∑ {{ piste.longueur }}m √ó {{ piste.largeur }}m ¬∑ {{ piste.orientation }}
              </option>
            }
          </select>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
          <button (click)="preparerAtterrissageComplet()" class="btn-primary" style="flex: 1;">
            üíæ Valider
          </button>
          <button (click)="selectedVolForPreparationAtterrissage = null" class="btn-secondary" style="flex: 1;">
            ‚úñÔ∏è Annuler
          </button>
        </div>
      </div>
    </div>
  }
 <!-- MODAL API EXTERNE -->
  @if (showExternesModal) {
    <div class="modal-overlay" (click)="showExternesModal = false">
      <div class="modal" (click)="$event.stopPropagation()" style="max-width: 900px;">
        <div class="modal-header">
          <h3 class="modal-title">üåç Vols de l'A√©roport Partenaire (FTG)</h3>
          <button class="close-btn" (click)="showExternesModal = false">‚úñÔ∏è</button>
        </div>

        <div class="table-container" style="box-shadow: none; margin-top: 0;">
          <table style="font-size: 0.9rem;">
            <thead>
            <tr>
              <th>Vol</th>
              <th>Trajet</th>
              <th>Horaires</th>
              <th>Statut</th>
            </tr>
            </thead>
            <tbody>
              @for (vol of volsExternes; track vol.numeroVol) {
                <tr>
                  <td><strong>{{ vol.numeroVol }}</strong></td>
                  <td>
                  <span [style.color]="vol.destination === 'BJA' ? '#10b981' : 'inherit'">
                    {{ vol.origine }} ‚Üí {{ vol.destination }}
                  </span>
                    @if (vol.destination === 'BJA') { <small>(Arriv√©e chez nous)</small> }
                  </td>
                  <td>
                    <div style="margin-bottom: 4px;">
                      <strong>üõ´ D√©collage :</strong> {{ vol.heureDepart | date:'dd/MM/yyyy HH:mm' }}
                    </div>
                    <div style="color: var(--secondary);">
                      <strong>üõ¨ Arriv√©e :</strong> {{ vol.heureArrivee | date:'dd/MM/yyyy HH:mm' }}
                    </div>
                  </td>
                  <td>
                   <span class="status-badge"
                         [class.status-libre]="vol.statut === 'PROGRAMME'"
                         [class.status-occupee]="vol.statut === 'EN_VOL' || vol.statut === 'ENREGISTREMENT' || vol.statut === 'EN_APPROCHE' || vol.statut === 'DECOLLE' || vol.statut === 'PRET_DECOLLAGE' || vol.statut === 'EMBARQUEMENT'"
                         [class.status-maintenance]="vol.statut === 'ATTERRI' || vol.statut === 'RETARDE' || vol.statut === 'ARRIVE'"
                         [class.status-danger]="vol.statut === 'ANNULE' || vol.statut === 'DETOURNE'">
                      {{ vol.statut }}
                   </span>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--secondary); text-align: center; font-style: italic;">
          üí° Ces donn√©es proviennent de l'API de l'a√©roport partenaire.
        </div>
      </div>
    </div>
  }

</div>
